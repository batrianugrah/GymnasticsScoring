{% extends 'layout.html' %}
{% block title %}Input Skor - {{ event.nama }}{% endblock %}

{% block content %}
{% include 'event_subnav.html' %}

<!-- LANGKAH 1: Simpan event.id di dalam atribut data-event-id -->
<div class="row" data-event-id="{{ event.id }}">
    <div class="col-lg-5">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white"><h4>üìù Input Nilai Pertandingan</h4></div>
            <div class="card-body">
                <form action="{{ url_for('input_skor', event_id=event.id) }}" method="post">
                    <div class="mb-3"><label class="form-label">1. Pilih Kategori</label><select class="form-select" id="kategori" name="kategori_id" required><option value="">-- Pilih Kategori --</option>{% for k in data.kategori %}<option value="{{ k.id }}">{{ k.nama }}</option>{% endfor %}</select></div>
                    <div class="mb-3"><label class="form-label">2. Pilih Grup</label><select class="form-select" id="grup" name="grup_id" required><option value="">-- Pilih Grup --</option>{% for g in data.grup %}<option value="{{ g.id }}">{{ g.nama }}</option>{% endfor %}</select></div>
                    <div class="mb-3"><label class="form-label">3. Pilih Alat</label><select class="form-select" id="alat" name="alat" required><option value="">-- Pilih Alat --</option>{% for a in data.alat %}<option value="{{ a.id }}">{{ a.nama }}</option>{% endfor %}</select></div>
                    <div class="mb-3"><label class="form-label">4. Pilih Peserta</label><select class="form-select" id="peserta" name="peserta" required><option value="">-- Isi semua filter di atas --</option></select></div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-sm-4"><label class="form-label">Nilai D</label><input type="number" step="0.001" class="form-control" name="nilai_d" required></div>
                        <div class="col-sm-4"><label class="form-label">Nilai E</label><input type="number" step="0.001" class="form-control" name="nilai_e" required></div>
                        <div class="col-sm-4"><label class="form-label">Nilai A</label><input type="number" step="0.001" class="form-control" name="nilai_a"></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Penalti</label><input type="number" step="0.001" class="form-control" name="penalti" value="0"></div>
                    <button type="submit" class="btn btn-primary w-100">Simpan Skor</button>
                </form>
            </div>
        </div>
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-warning text-dark"><h4>‚öôÔ∏è Kontrol Ronde</h4></div>
            <div class="card-body">
                <p>Gunakan tombol ini setelah satu ronde selesai untuk mengosongkan papan skor live.</p>
                <form action="{{ url_for('archive_scores', event_id=event.id) }}" method="post" onsubmit="return confirm('Yakin ingin mengarsipkan skor live saat ini?');">
                    <button type="submit" class="btn btn-warning w-100">Arsipkan Skor & Lanjutkan</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-7">
        <h3 class="mb-3">üìä Ranking Sementara (Live)</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark"><tr><th>#</th><th>Nama</th><th>Alat</th><th>Total</th><th>Aksi</th></tr></thead>
                <tbody>
                {% for s in ranking %}
                    <tr>
                        <td><strong>{{ loop.index }}</strong></td>
                        <td><a href="{{ url_for('profil_peserta', peserta_id=s.peserta.id) }}" class="participant-link">{{ s.peserta.nama }}</a><small class="text-muted d-block">{{ s.peserta.daerah.nama }}</small></td>
                        <td>{{ s.alat.nama }}</td>
                        <td><span class="badge bg-success fs-6">{{ "%.3f"|format(s.total_nilai) }}</span></td>
                        <td><a href="{{ url_for('edit_skor', skor_id=s.id) }}" class="btn btn-sm btn-warning">Edit</a></td>
                    </tr>
                {% else %}
                    <tr><td colspan="5" class="text-center">Belum ada skor live.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // LANGKAH 2: Baca eventId dari atribut data-*
    const container = document.querySelector('.row[data-event-id]');
    const eventId = container.dataset.eventId;

    const kategoriSelect = document.getElementById('kategori');
    const grupSelect = document.getElementById('grup');
    const alatSelect = document.getElementById('alat');
    const pesertaSelect = document.getElementById('peserta');

    async function fetchPeserta() {
        const kategoriId = kategoriSelect.value;
        const grupId = grupSelect.value;
        const alatId = alatSelect.value;
        pesertaSelect.innerHTML = '<option value="">-- Memuat Peserta... --</option>';
        if (!kategoriId || !grupId || !alatId) {
            pesertaSelect.innerHTML = '<option value="">-- Isi semua filter di atas --</option>';
            return;
        }
        try {
            const response = await fetch(`/api/event/${eventId}/peserta_by_filters?kategori_id=${kategoriId}&grup_id=${grupId}&alat_id=${alatId}`);
            if (!response.ok) throw new Error('Gagal mengambil data');
            const pesertas = await response.json();
            if (pesertas.length > 0) {
                let options = '<option value="">-- Pilih Peserta --</option>';
                pesertas.forEach(p => {
                    const text = `${p.nama} (${p.daerah})`;
                    const suffix = p.scored ? ' (Sudah dinilai ‚úì)' : '';
                    const disabled = p.scored ? 'disabled' : '';
                    options += `<option value="${p.id}" ${disabled}>${text}${suffix}</option>`;
                });
                pesertaSelect.innerHTML = options;
            } else {
                pesertaSelect.innerHTML = '<option value="">-- Tidak ada Peserta --</option>';
            }
        } catch (error) {
            console.error('Error:', error);
            pesertaSelect.innerHTML = '<option value="">-- Gagal Memuat --</option>';
        }
    }

    kategoriSelect.addEventListener('change', fetchPeserta);
    grupSelect.addEventListener('change', fetchPeserta);
    alatSelect.addEventListener('change', fetchPeserta);
});
</script>
{% endblock %}
